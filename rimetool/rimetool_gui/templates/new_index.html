<!DOCTYPE html>
<html lang="zh">

<head>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="website-title"></title>
    <link rel="stylesheet" href="{{ url_for('serve_static', filename='style.css') }}">
    <style>
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
        }
        .toast {
            margin-bottom: 0.5rem;
            padding: 1rem;
            border-radius: 0.5rem;
            min-width: 300px;
            max-width: 500px;
            animation: slideIn 0.3s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
        }
        .toast-success {
            background-color: #10B981;
            color: white;
        }
        .toast-error {
            background-color: #EF4444;
            color: white;
        }
        .toast-info {
            background-color: #3B82F6;
            color: white;
        }
        .toast-warning {
            background-color: #F59E0B;
            color: white;
        }
        #debug-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-background text-foreground flex flex-col items-center justify-center p-4">
    <h1 id="website-name" class="text-5xl font-bold text-primary mb-6"></h1>

    <div id="error" class="error hidden text-destructive bg-red-100 border border-red-400 p-4 rounded mb-4"></div>
    <!-- <div id="success" class="success hidden text-accent bg-yellow-100 border border-yellow-400 p-4 rounded mb-4">å¤„ç†æˆåŠŸï¼</div>
    <div id="loading" class="loading text-secondary hidden">å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</div>  -->

    <div id="toast-container" class="toast-container"></div>

    <div id="debug-info" class="debug-info hidden bg-zinc-100 border border-zinc-300 p-4 rounded mb-4 rounded-lg shadow-lg ">
        <h3 class="font-semibold">è°ƒè¯•ä¿¡æ¯æ±‡æ€»ï¼š</h3>
        <pre id="debug-content"></pre>
    </div>

    <!-- ä¸‹è½½å†å²è®°å½• -->
    <div id="download-history" class="hidden bg-blue-50 border border-blue-300 p-4 rounded mb-4 rounded-lg shadow-lg">
        <h3 class="font-semibold mb-2">ä¸‹è½½è®°å½•ï¼š</h3>
        <div id="history-list" class="space-y-2 max-h-60 overflow-y-auto">
            <!-- å†å²è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
        </div>
        <p class="mt-3 text-sm text-gray-600">
            æç¤º: ä¸‹è½½æ–‡ä»¶é»˜è®¤ä¿å­˜åœ¨æµè§ˆå™¨çš„é»˜è®¤ä¸‹è½½æ–‡ä»¶å¤¹ä¸­ã€‚æ‚¨å¯ä»¥åœ¨æµè§ˆå™¨è®¾ç½®ä¸­æ›´æ”¹ä¸‹è½½ä½ç½®ã€‚
        </p>
    </div>

    <!-- æ–‡ä»¶è¾“å…¥éƒ¨åˆ† -->
    <div class="bg-card p-6 rounded-lg shadow-lg form-container mb-4">
        <h2 class="text-xl font-bold mb-4">é EPUB æ–‡ä»¶è¾“å…¥</h2>
        <label for="file" class="block font-bold mb-2">é€‰æ‹©æ–‡ä»¶ï¼š</label>
        <label for="file" class="file-label">ğŸ“‚ é€‰æ‹©æ–‡ä»¶ </label>
        <input type="file" id="file" required class="border border-border rounded p-2 mb-4 w-full"  />
        <input type="text" id="file-path" class="border border-border rounded p-2 mb-4 w-full" placeholder="æœªé€‰æ‹©æ–‡ä»¶" readonly />

        <label for="tool" class="block font-bold mb-2">é€‰æ‹©å·¥å…·ï¼š</label>
        <select id="tool-file" required class="border border-border rounded p-2 mb-4 w-full">
            <option value="selection">è¯·é€‰æ‹©å·¥å…·</option>
            <option value="vcf">VCF</option>
            <!-- <option value="simple-english">Simple English</option> -->
            <option value="se">Simple English (se)</option>
            <!-- <option value="simple-chinese">Simple Chinese</option> -->
            <option value="sc">Simple Chinese (sc)</option>
            <option value="tosougou">To Sogou</option>
        </select>

        <button onclick="processFile('file')"
            class="bg-primary text-primary-foreground  rounded p-2 w-full transition duration-300">å¤„ç†æ–‡ä»¶</button>
    </div>

    <!-- EPUB æ–‡ä»¶å¤¹è¾“å…¥éƒ¨åˆ†ï¼ˆé€‰é¡¹ 1 å’Œ 4ï¼‰ -->
    <div class="bg-card p-6 rounded-lg shadow-lg form-container mb-4">
        <h2 class="text-xl font-bold mb-4">EPUB ZIP æ–‡ä»¶è¾“å…¥ - è½¬ txt æˆ– rime</h2>
        <label for="folder-1-4" class="block font-bold mb-2">é€‰æ‹© EPUB çš„ ZIP æ ¼å¼æ–‡ä»¶ï¼ˆå¼ºçƒˆå»ºè®® ZIP ä¸­ç¬¬ä¸€å±‚å°±æœ‰ META-INF æ–‡ä»¶å¤¹ï¼‰ï¼š</label>
        <label for="folder-1-4" class="file-label">ğŸ“‚ é€‰æ‹©æ–‡ä»¶ </label>
        <input type="file" id="folder-1-4" required class="border border-border rounded p-2 mb-4 w-full" accept=".zip" />
        <input type="text" id="folder-path-1-4" class="border border-border rounded p-2 mb-4 w-full" placeholder="æœªé€‰æ‹©æ–‡ä»¶" readonly />

        <label for="output-folder-1-4" class="block font-bold mb-2">é€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹ï¼šï¼ˆæœ¬åœ°è¿è¡Œå¯é€‰ï¼ŒæœåŠ¡å™¨è¿è¡Œå°†ä½¿ç”¨æœåŠ¡å™¨é»˜è®¤è·¯å¾„ï¼‰</label>
        <label for="output-folder-1-4" class="file-label">ğŸ“‚ é€‰æ‹©æ–‡ä»¶å¤¹ </label>
        <input type="file" id="output-folder-1-4" class="border border-border rounded p-2 mb-4 w-full" webkitdirectory directory />
        <input type="text" id="output-folder-path-1-4" class="border border-border rounded p-2 mb-4 w-full" placeholder="æœªé€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹ï¼ˆå°†ä½¿ç”¨é»˜è®¤è·¯å¾„ï¼‰" readonly />

        <label for="mode-1-4" class="block font-bold mb-2">æ¨¡å¼é€‰æ‹©ï¼š</label>
        <select id="mode-1-4" class="border border-border rounded p-2 mb-4 w-full">
            <option value="epub_to_txt">1. epub_to_txt - å°† EPUB è½¬æ¢ä¸ºçº¯æ–‡æœ¬</option>
            <option value="epub_to_rime">4. epub_to_rime - å®Œæ•´çš„ EPUB åˆ° rime è½¬æ¢æµç¨‹</option>
        </select>

        <button onclick="processFile('folder-1-4')"
            class="bg-primary text-primary-foreground  rounded p-2 w-full transition duration-300">å¤„ç†æ–‡ä»¶</button>
    </div>

    <!-- EPUB æ–‡ä»¶è¾“å…¥éƒ¨åˆ†ï¼ˆé€‰é¡¹ 2 å’Œ 3ï¼‰ -->
    <div class="bg-card p-6 rounded-lg shadow-lg form-container">
        <h2 class="text-xl font-bold mb-4">EPUB ä¹‹ txt è½¬é•¿çŸ­å¥ï¼Œæˆ– txt è½¬ rime</h2>
        <label for="file-2-3" class="block font-bold mb-2">é€‰æ‹© txt æ–‡ä»¶ï¼š</label>
        <label for="file-2-3" class="file-label">ğŸ“‚ é€‰æ‹©æ–‡ä»¶ </label>
        <input type="file" id="file-2-3" required class="border border-border rounded p-2 mb-4 w-full"  />
        <input type="text" id="file-path-2-3" class="border border-border rounded p-2 mb-4 w-full" placeholder="æœªé€‰æ‹©æ–‡ä»¶" readonly />

        <label for="output-folder-2-3" class="block font-bold mb-2">é€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹ï¼šï¼ˆå¯é€‰ï¼Œä¸é€‰æ‹©å°†ä½¿ç”¨æœåŠ¡å™¨é»˜è®¤è·¯å¾„ï¼‰</label>
        <label for="output-folder-2-3" class="file-label">ğŸ“‚ é€‰æ‹©æ–‡ä»¶å¤¹ </label>
        <input type="file" id="output-folder-2-3" class="border border-border rounded p-2 mb-4 w-full" webkitdirectory directory />
        <input type="text" id="output-folder-path-2-3" class="border border-border rounded p-2 mb-4 w-full" placeholder="æœªé€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹ï¼ˆå°†ä½¿ç”¨é»˜è®¤è·¯å¾„ï¼‰" readonly />

        <label for="mode-2-3" class="block font-bold mb-2">æ¨¡å¼é€‰æ‹©ï¼š</label>
        <select id="mode-2-3" class="border border-border rounded p-2 mb-4 w-full">
            <option value="txt_to_short_long">2. txt_to_short_long - å°†æ–‡æœ¬è½¬æ¢ä¸ºçŸ­å¥å’Œé•¿å¥</option>
            <option value="txt_to_rime">3. txt_to_rime - å°†æ–‡æœ¬è½¬æ¢ä¸º rime æ ¼å¼</option>
        </select>

        <button onclick="processFile('file-2-3')"
            class="bg-primary text-primary-foreground  rounded p-2 w-full transition duration-300">å¤„ç†æ–‡ä»¶</button>
    </div>

    <script>
        function log(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            const debugContent = document.getElementById('debug-content');

            // åˆ›å»ºtoastå…ƒç´ 
            const toast = document.createElement('div');
            // å®Œæ•´çš„æ—¥æœŸæ—¶é—´æ ¼å¼ï¼Œå¦‚ "2025å¹´4æœˆ8æ—¥ 14:30:45"
            const now = new Date();
            const timestamp = now.getFullYear() + 'å¹´' + 
                             (now.getMonth() + 1) + 'æœˆ' + 
                             now.getDate() + 'æ—¥ ' + 
                             now.getHours() + ':' + 
                             String(now.getMinutes()).padStart(2, '0') + ':' + 
                             String(now.getSeconds()).padStart(2, '0');
            
            debugContent.textContent += `[${timestamp}] ${message}\n`;
            document.getElementById('debug-info').style.display = 'block';

            // å¦‚æœæ˜¯æˆåŠŸå¤„ç†æ–‡ä»¶çš„æ¶ˆæ¯ï¼Œä½¿ç”¨successç±»å‹
            if (message.includes('å¤„ç†æˆåŠŸ') && message.includes('outputs')) {
                type = 'success';
            }

            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <span class="font-bold mr-2">[${timestamp}]</span>
                    <span>${message}</span>
                </div>
            `;

            // æ·»åŠ åˆ°å®¹å™¨
            const container = document.getElementById('toast-container');
            container.appendChild(toast);

            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease-in-out';
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
        function showDetailedError(error) {
            log(`è¯¦ç»†é”™è¯¯: ${JSON.stringify(error)}`, 'error');
            
            // åˆ›å»ºè¯¦ç»†é”™è¯¯å¯¹è¯æ¡†
            const errorDialog = document.createElement('div');
            errorDialog.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
            errorDialog.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-lg w-full">
                    <h3 class="text-xl font-bold mb-4 text-red-600">é”™è¯¯è¯¦æƒ…</h3>
                    <div class="mb-4 overflow-auto max-h-96 bg-gray-100 p-4 rounded">
                        <pre class="whitespace-pre-wrap">${JSON.stringify(error, null, 2)}</pre>
                    </div>
                    <div class="flex justify-end">
                        <button id="close-error" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">å…³é—­</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(errorDialog);
            
            document.getElementById('close-error').addEventListener('click', function() {
                document.body.removeChild(errorDialog);
            });
        }

        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        document.getElementById('file').addEventListener('change', function () {
            const filePathInput = document.getElementById('file-path');
            if (this.files.length > 0) {
                filePathInput.value = this.files[0].name;
            } else {
                filePathInput.value = 'æœªé€‰æ‹©æ–‡ä»¶';
            }
        });

        // ZIP æ–‡ä»¶é€‰æ‹©äº‹ä»¶ï¼ˆé€‰é¡¹ 1 å’Œ 4ï¼‰
        document.getElementById('folder-1-4').addEventListener('change', function () {
            const filePathInput = document.getElementById('folder-path-1-4');
            if (this.files.length > 0) {
                const fileName = this.files[0].name;
                if (fileName.toLowerCase().endsWith('.zip')) {
                    filePathInput.value = fileName;
                    log(`å·²é€‰æ‹© ZIP æ–‡ä»¶: ${fileName}`, 'info');
                } else {
                    filePathInput.value = 'è¯·é€‰æ‹© ZIP æ–‡ä»¶';
                    log('è¯·é€‰æ‹© ZIP æ–‡ä»¶', 'error');
                    this.value = ''; // æ¸…ç©ºé€‰æ‹©
                }
            } else {
                filePathInput.value = 'æœªé€‰æ‹©æ–‡ä»¶';
            }
        });

        // è¾“å‡ºæ–‡ä»¶å¤¹é€‰æ‹©äº‹ä»¶ï¼ˆé€‰é¡¹ 1 å’Œ 4ï¼‰
        document.getElementById('output-folder-1-4').addEventListener('change', function () {
            const outputFolderPathInput = document.getElementById('output-folder-path-1-4');
            if (this.files.length > 0) {
                const firstFile = this.files[0];
                const folderPath = firstFile.webkitRelativePath.split('/')[0];
                outputFolderPathInput.value = folderPath;
            } else {
                outputFolderPathInput.value = 'æœªé€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹ï¼ˆå°†ä½¿ç”¨é»˜è®¤è·¯å¾„ï¼‰';
            }
        });

        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶ï¼ˆé€‰é¡¹ 2 å’Œ 3ï¼‰
        document.getElementById('file-2-3').addEventListener('change', function () {
            const filePathInput = document.getElementById('file-path-2-3');
            if (this.files.length > 0) {
                filePathInput.value = this.files[0].name;
            } else {
                filePathInput.value = 'æœªé€‰æ‹©æ–‡ä»¶';
            }
        });

        // è¾“å‡ºæ–‡ä»¶å¤¹é€‰æ‹©äº‹ä»¶ï¼ˆé€‰é¡¹ 2 å’Œ 3ï¼‰
        document.getElementById('output-folder-2-3').addEventListener('change', function () {
            const outputFolderPathInput = document.getElementById('output-folder-path-2-3');
            if (this.files.length > 0) {
                const firstFile = this.files[0];
                const folderPath = firstFile.webkitRelativePath.split('/')[0];
                outputFolderPathInput.value = folderPath;
            } else {
                outputFolderPathInput.value = 'æœªé€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹ï¼ˆå°†ä½¿ç”¨é»˜è®¤è·¯å¾„ï¼‰';
            }
        });

        function processFile(type) {
            log('å¼€å§‹å¤„ç†');

            let fileOrFolderInput, toolOrModeInput, pathInput, outputFolderInput, outputFolderPathInput;
            let toolOrMode, outputFolderPath;

            if (type === 'file') {
                fileOrFolderInput = document.getElementById('file');
                toolOrModeInput = document.getElementById('tool-file');
                pathInput = document.getElementById('file-path');
            } else if (type === 'folder-1-4') {
                fileOrFolderInput = document.getElementById('folder-1-4');
                toolOrModeInput = document.getElementById('mode-1-4');
                pathInput = document.getElementById('folder-path-1-4');
                outputFolderInput = document.getElementById('output-folder-1-4');
                outputFolderPathInput = document.getElementById('output-folder-path-1-4');
            } else if (type === 'file-2-3') {
                fileOrFolderInput = document.getElementById('file-2-3');
                toolOrModeInput = document.getElementById('mode-2-3');
                pathInput = document.getElementById('file-path-2-3');
                outputFolderInput = document.getElementById('output-folder-2-3');
                outputFolderPathInput = document.getElementById('output-folder-path-2-3');
            }

            // const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            // const success = document.getElementById('success');

            // æ£€æŸ¥æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
            if ((type === 'file' && fileOrFolderInput.files.length === 0) ||
                (type === 'folder-1-4' && fileOrFolderInput.files.length === 0) ||
                (type === 'file-2-3' && fileOrFolderInput.files.length === 0)) {
                const errorMsg = type === 'file' || type === 'file-2-3' ? 'è¯·é€‰æ‹©æ–‡ä»¶' : 'è¯·é€‰æ‹©æ–‡ä»¶å¤¹';
                log(errorMsg, 'error');
                error.textContent = errorMsg;
                error.style.display = 'block';
                return;
            }

            // æ£€æŸ¥è¾“å‡ºæ–‡ä»¶å¤¹
            if ((type === 'folder-1-4' || type === 'file-2-3') && outputFolderInput.files.length === 0) {
                // ä¸é€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹æ—¶ï¼Œä½¿ç”¨é»˜è®¤è·¯å¾„
                log('æœªé€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹ï¼Œä½¿ç”¨é»˜è®¤è·¯å¾„', 'info');
                outputFolderPath = 'default_output';
            } else if (type === 'folder-1-4' || type === 'file-2-3') {
                outputFolderPath = outputFolderPathInput.value;
            }

            toolOrMode = toolOrModeInput.value;

            // å‡†å¤‡è¡¨å•æ•°æ®
            const formData = new FormData();
            if (type === 'file') {
                // å•ä¸ªéEPUBæ–‡ä»¶å¤„ç†
                formData.append('file', fileOrFolderInput.files[0]); // æ–‡ä»¶å¯¹è±¡
                formData.append('tool', toolOrMode); // å·¥å…·ç±»å‹ (vcf, se, sc, tosougou)
            } else if (type === 'folder-1-4') {
                // ZIPæ–‡ä»¶å¤„ç†ï¼ˆEPUBï¼‰
                formData.append('zip_file', fileOrFolderInput.files[0]); // ZIPæ–‡ä»¶å¯¹è±¡
                formData.append('is_zip_file', 'true'); // æ ‡è®°ä¸ºZIPæ–‡ä»¶
                formData.append('mode', toolOrMode); // æ¨¡å¼ (epub_to_txt, epub_to_rime)
                
                // å¦‚æœæŒ‡å®šäº†è¾“å‡ºæ–‡ä»¶å¤¹
                if (outputFolderPath && outputFolderPath !== 'default_output') {
                    formData.append('output_folder', outputFolderPath); // è¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„
                }
            } else if (type === 'file-2-3') {
                // æ–‡æœ¬æ–‡ä»¶å¤„ç†
                formData.append('file', fileOrFolderInput.files[0]); // æ–‡ä»¶å¯¹è±¡
                formData.append('mode', toolOrMode); // æ¨¡å¼ (txt_to_short_long, txt_to_rime)
                formData.append('tool', 'epub'); // 
                
                // å¦‚æœæŒ‡å®šäº†è¾“å‡ºæ–‡ä»¶å¤¹
                if (outputFolderPath && outputFolderPath !== 'default_output') {
                    formData.append('output_folder', outputFolderPath); // è¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„
                }
            }
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            log(`å‡†å¤‡å‘é€è¯·æ±‚ - å‚æ•°:`, 'info');
            for (let pair of formData.entries()) {
                if (!pair[0].includes('file') && !pair[0].includes('zip_file')) { // ä¸æ˜¾ç¤ºæ–‡ä»¶å†…å®¹
                    log(`${pair[0]}: ${pair[1]}`, 'info');
                } else {
                    const fileObj = pair[1];
                    if (fileObj instanceof File) {
                        log(`${pair[0]}: æ–‡ä»¶ "${fileObj.name}", å¤§å°: ${(fileObj.size / 1024).toFixed(2)} KB`, 'info');
                    } else {
                        log(`${pair[0]}: [æ•°æ®]`, 'info');
                    }
                }
            }

            log(`å‡†å¤‡å‘é€è¯·æ±‚ - ${type}: ${pathInput.value}, ${type === 'file' ? 'å·¥å…·' : 'æ¨¡å¼'}: ${toolOrMode}`);
            if (outputFolderPath) {
                log(`è¾“å‡ºæ–‡ä»¶å¤¹: ${outputFolderPath}`);
            }

            // æ›´æ–° UI çŠ¶æ€
            // loading.style.display = 'block';
            error.style.display = 'none';
            // success.style.display = 'none';

            // è®¾ç½®è¯·æ±‚è¶…æ—¶é”™è¯¯å¤„ç†
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 600000); // 10åˆ†é’Ÿè¶…æ—¶ï¼Œå¤„ç†å¤§æ–‡ä»¶
            
            // å…ˆæµ‹è¯•æœåŠ¡å™¨æ˜¯å¦å¯ç”¨
            fetch('http://127.0.0.1:5001/', { 
                method: 'GET',
                // signal: AbortSignal.timeout(5001), // 5ç§’è¶…æ—¶
                mode: 'cors'
            })
            .then(response => {
                if (response.ok) {
                    log('æœåŠ¡å™¨è¿æ¥æ­£å¸¸ï¼Œå¼€å§‹ä¸Šä¼ æ–‡ä»¶...', 'info');
                    sendMainRequest();
                } else {
                    throw new Error('æœåŠ¡å™¨çŠ¶æ€å¼‚å¸¸');
                }
            })
            .catch(err => {
                log('æœåŠ¡å™¨è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œå°è¯•ç»§ç»­ä¸Šä¼ ...', 'warning');
                log(`è¿æ¥æµ‹è¯•é”™è¯¯: ${err.message}`, 'warning');
                // å³ä½¿è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œä»ç„¶å°è¯•ä¸»è¯·æ±‚
                sendMainRequest();
            });
            
            // ä¸»è¯·æ±‚å‡½æ•°
            function sendMainRequest() {
                // å‘é€è¯·æ±‚
                fetch('http://127.0.0.1:5001/process', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                    },
                    mode: 'cors',
                    credentials: 'same-origin'
                })
                .then(response => {
                    clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶
                    
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(text);
                        });
                    }
                    return response;
                })
                .then(response => {
                    log(`æ”¶åˆ°å“åº” - çŠ¶æ€: ${response.status}`);
                    
                    // æ£€æŸ¥å“åº”çš„Content-Type
                    const contentType = response.headers.get('Content-Type');
                    log(`å“åº”å†…å®¹ç±»å‹: ${contentType}`);
                    
                    // å¦‚æœæ˜¯ä¸‹è½½æ–‡ä»¶çš„å“åº”
                    if (contentType && (contentType.includes('application/octet-stream') || 
                                       contentType.includes('application/zip'))) {
                        log('æ£€æµ‹åˆ°æ–‡ä»¶ä¸‹è½½ï¼Œå¼€å§‹ä¸‹è½½...');
                        return response.blob().then(blob => {
                            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„<a>å…ƒç´ ç”¨äºä¸‹è½½
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            
                            // ä»Content-Dispositionå¤´ä¸­æå–æ–‡ä»¶å
                            const contentDisposition = response.headers.get('Content-Disposition');
                            let filename = 'download.txt';
                            
                            if (contentDisposition) {
                                // ä½¿ç”¨æ›´ç²¾ç¡®çš„æ­£åˆ™è¡¨è¾¾å¼æå–æ–‡ä»¶å
                                const filenameRegex = /filename=([^;]*)|filename\*=UTF-8''([^;]*)/;
                                const matches = filenameRegex.exec(contentDisposition);
                                
                                if (matches) {
                                    // è·å–åŒ¹é…åˆ°çš„æ–‡ä»¶åï¼ˆä¼˜å…ˆä½¿ç”¨UTF-8ç¼–ç çš„æ–‡ä»¶åï¼‰
                                    const extractedName = matches[2] || matches[1];
                                    if (extractedName) {
                                        try {
                                            // è§£ç æ–‡ä»¶åï¼ˆå¤„ç†URLç¼–ç å’ŒUTF-8ç¼–ç ï¼‰
                                            filename = decodeURIComponent(extractedName.replace(/["']/g, ''));
                                            log(`æˆåŠŸæå–æ–‡ä»¶å: ${filename}`, 'info');
                                        } catch (e) {
                                            log(`æ–‡ä»¶åè§£ç å¤±è´¥: ${e.message}`, 'warning');
                                        }
                                    }
                                }
                            }

                            // å¦‚æœæ²¡æœ‰æˆåŠŸè·å–æ–‡ä»¶åæˆ–æ–‡ä»¶åæ— æ•ˆï¼Œä½¿ç”¨æ—¶é—´æˆ³ç”Ÿæˆæ–‡ä»¶å
                            if (filename === 'download.txt' || !filename) {
                                const now = new Date();
                                const timestamp = now.getFullYear() +
                                    String(now.getMonth() + 1).padStart(2, '0') +
                                    String(now.getDate()).padStart(2, '0') + '_' +
                                    String(now.getHours()).padStart(2, '0') +
                                    String(now.getMinutes()).padStart(2, '0') +
                                    String(now.getSeconds()).padStart(2, '0');
                                
                                // ä»å“åº”å¤´è·å–Content-Typeæ¥ç¡®å®šæ–‡ä»¶æ‰©å±•å
                                const contentType = response.headers.get('Content-Type');
                                let extension = '.txt';
                                
                                if (contentType) {
                                    if (contentType.includes('application/zip')) {
                                        extension = '.zip';
                                    } else if (contentType.includes('text/plain')) {
                                        extension = '.txt';
                                    } else if (contentType.includes('application/yaml')) {
                                        extension = '.yaml';
                                    }
                                    // å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šç±»å‹
                                }
                                
                                filename = `output_${timestamp}${extension}`;
                                log(`ä½¿ç”¨ç”Ÿæˆçš„æ–‡ä»¶å: ${filename}`, 'info');
                            }
                            
                            a.download = filename;
                            
                            // æ˜¾ç¤ºä¸‹è½½æç¤º
                            showDownloadHelp(filename);
                            
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            log(`æ–‡ä»¶ "${filename}" ä¸‹è½½ä¸­...`, 'success');
                            
                            // ä¿å­˜ä¸‹è½½ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
                            saveLastDownload(filename);
                            
                            return Promise.resolve();
                        });
                    } else {
                        // ä¸æ˜¯ä¸‹è½½æ–‡ä»¶çš„å“åº”
                        log('å¤„ç†æˆåŠŸï¼Œä½†æœªæ”¶åˆ°æ–‡ä»¶ä¸‹è½½å“åº”');
                        return Promise.resolve();
                    }
                })
                .then(() => {
                    error.style.display = 'none';
                    log('å¤„ç†æˆåŠŸï¼Œå¤„ç†å¥½çš„æ–‡ä»¶ä½äº gui/outputs æ–‡ä»¶å¤¹ä¸­ï¼');
                    log('å¦‚æœæ²¡æœ‰è‡ªåŠ¨ä¸‹è½½ï¼Œè¯·æŸ¥çœ‹åç«¯æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯');
                })
                .catch(err => {
                    clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶
                    
                    let errorMsg = err.message || 'æœªçŸ¥é”™è¯¯';
                    
                    // å¤„ç†ç‰¹å®šç±»å‹çš„é”™è¯¯
                    if (err.name === 'AbortError') {
                        errorMsg = 'è¯·æ±‚è¶…æ—¶ï¼ˆ10åˆ†é’Ÿï¼‰ï¼ŒæœåŠ¡å™¨å¤„ç†æ—¶é—´è¿‡é•¿';
                    } else if (err instanceof TypeError && err.message.includes('Failed to fetch')) {
                        errorMsg = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨(http://127.0.0.1:5001)ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ';
                        // å°è¯•æä¾›æ›´å¤šè°ƒè¯•ä¿¡æ¯
                        log('å°è¯•è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·ç¡®ä¿ï¼š', 'error');
                        log('1. PythonæœåŠ¡å™¨æ­£åœ¨è¿è¡Œ (python new_app.py)', 'error');
                        log('2. æœåŠ¡å™¨æ­£åœ¨ç›‘å¬5001ç«¯å£', 'error');
                        log('3. æ²¡æœ‰é˜²ç«å¢™é˜»æ­¢è¿æ¥', 'error');
                        log('4. æµè§ˆå™¨å…è®¸è·¨åŸŸè¯·æ±‚', 'error');
                    }
                    
                    log(`å‘ç”Ÿé”™è¯¯: ${errorMsg}`, 'error');
                    error.textContent = 'é”™è¯¯ï¼š' + errorMsg;
                    error.style.display = 'block';
                    
                    // æ·»åŠ è¯¦æƒ…æŒ‰é’®
                    const detailButton = document.createElement('button');
                    detailButton.textContent = 'æŸ¥çœ‹è¯¦æƒ…';
                    detailButton.className = 'bg-yellow-500 text-white px-4 py-2 rounded mt-2 mr-2';
                    detailButton.onclick = function() {
                        showDetailedError({
                            message: err.message,
                            name: err.name,
                            stack: err.stack,
                            type: type,
                            formData: Array.from(formData.entries())
                                .filter(pair => !pair[0].includes('file') && !pair[0].includes('zip_file'))
                                .reduce((obj, [key, value]) => {
                                    obj[key] = value;
                                    return obj;
                                }, {}),
                            server: {
                                url: 'http://127.0.0.1:5001',
                                endpoint: '/process',
                                method: 'POST'
                            }
                        });
                    };
                    error.appendChild(detailButton);
                    
                    // æ·»åŠ é‡è¯•æŒ‰é’®
                    const retryButton = document.createElement('button');
                    retryButton.textContent = 'é‡è¯•';
                    retryButton.className = 'bg-blue-500 text-white px-4 py-2 rounded mt-2';
                    retryButton.onclick = function() {
                        processFile(type);
                    };
                    error.appendChild(retryButton);
                });
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆæ—¶çš„åˆå§‹åŒ–
        window.onload = function () {
            log('é¡µé¢å·²åŠ è½½å®Œæˆ');
            
            // æ˜¾ç¤ºä¸Šæ¬¡ä¸‹è½½çš„ä¿¡æ¯
            try {
                const lastDownloadStr = localStorage.getItem('lastDownload');
                if (lastDownloadStr) {
                    const lastDownload = JSON.parse(lastDownloadStr);
                    const now = new Date();
                    const timeDiff = (now.getTime() - lastDownload.timestamp) / (1000 * 60 * 60); // å°æ—¶
                    if (timeDiff < 24) { // å¦‚æœæ˜¯24å°æ—¶å†…çš„ä¸‹è½½
                        // ç¡®ä¿æ—¶é—´æ ¼å¼æ˜¯å¹´æœˆæ—¥æ ¼å¼
                        let displayTime = lastDownload.time;
                        if (!displayTime || displayTime.indexOf('å¹´') === -1) {
                            const downloadDate = new Date(lastDownload.timestamp);
                            displayTime = downloadDate.getFullYear() + 'å¹´' + 
                                        (downloadDate.getMonth() + 1) + 'æœˆ' + 
                                        downloadDate.getDate() + 'æ—¥ ' + 
                                        downloadDate.getHours() + ':' + 
                                        String(downloadDate.getMinutes()).padStart(2, '0') + ':' + 
                                        downloadDate.getSeconds();
                        }
                        log(`ä¸Šæ¬¡ä¸‹è½½: "${lastDownload.filename}" (${displayTime})`, 'info');
                    }
                }
                
                // åŠ è½½å¹¶æ˜¾ç¤ºä¸‹è½½å†å²
                updateDownloadHistory();
            } catch (e) {
                console.error('è¯»å–ä¸‹è½½å†å²å¤±è´¥:', e);
            }
        };
        
        // ä¿å­˜ä¸Šæ¬¡ä¸‹è½½çš„ä¿¡æ¯
        function saveLastDownload(filename) {
            try {
                const now = new Date();
                const formattedTime = now.getFullYear() + 'å¹´' + 
                                     (now.getMonth() + 1) + 'æœˆ' + 
                                     now.getDate() + 'æ—¥ ' + 
                                     now.getHours() + ':' + 
                                     String(now.getMinutes()).padStart(2, '0') + ':' + 
                                     now.getSeconds();
                
                const downloadItem = {
                    filename: filename,
                    time: formattedTime,
                    timestamp: now.getTime()
                };
                
                // ä¿å­˜æœ€æ–°çš„ä¸‹è½½
                localStorage.setItem('lastDownload', JSON.stringify(downloadItem));
                
                // è·å–å†å²è®°å½•
                let history = [];
                const historyStr = localStorage.getItem('downloadHistory');
                if (historyStr) {
                    history = JSON.parse(historyStr);
                }
                
                // æ·»åŠ æ–°è®°å½•åˆ°å‰é¢
                history.unshift(downloadItem);
                
                // ä¿ç•™æœ€æ–°çš„10æ¡è®°å½•
                if (history.length > 10) {
                    history = history.slice(0, 10);
                }
                
                // ä¿å­˜å†å²è®°å½•
                localStorage.setItem('downloadHistory', JSON.stringify(history));
                
                // æ›´æ–°æ˜¾ç¤º
                updateDownloadHistory();
            } catch (e) {
                console.error('ä¿å­˜ä¸‹è½½ä¿¡æ¯å¤±è´¥:', e);
            }
        }
        
        // æ›´æ–°ä¸‹è½½å†å²è®°å½•æ˜¾ç¤º
        function updateDownloadHistory() {
            try {
                const historyStr = localStorage.getItem('downloadHistory');
                if (!historyStr) return;
                
                const history = JSON.parse(historyStr);
                if (history.length === 0) return;
                
                // æ˜¾ç¤ºä¸‹è½½å†å²åŒºåŸŸ
                const downloadHistoryElem = document.getElementById('download-history');
                downloadHistoryElem.classList.remove('hidden');
                
                // æ›´æ–°å†å²åˆ—è¡¨
                const historyListElem = document.getElementById('history-list');
                historyListElem.innerHTML = '';
                
                history.forEach(item => {
                    // å¦‚æœæ—¶é—´æ ¼å¼æ˜¯æ—¶é—´æˆ³ï¼Œè½¬æ¢ä¸ºæ ¼å¼åŒ–çš„æ—¥æœŸæ—¶é—´
                    let displayTime = item.time;
                    if (!displayTime || displayTime.indexOf('å¹´') === -1) {
                        const itemDate = new Date(item.timestamp);
                        displayTime = itemDate.getFullYear() + 'å¹´' + 
                                     (itemDate.getMonth() + 1) + 'æœˆ' + 
                                     itemDate.getDate() + 'æ—¥ ' + 
                                     itemDate.getHours() + ':' + 
                                     String(itemDate.getMinutes()).padStart(2, '0') + ':' + 
                                     itemDate.getSeconds();
                    }

                    const itemElem = document.createElement('div');
                    itemElem.className = 'border-b border-blue-200 pb-2';
                    itemElem.innerHTML = `
                        <div class="flex justify-between" style="margin: 0 10px;">
                            <span class="font-medium"  style="margin: 0 10px;">${item.filename}</span>
                            <span class="text-sm text-gray-500"  style="margin: 0 10px;">${displayTime}</span>
                        </div>
                    `;
                    historyListElem.appendChild(itemElem);
                });
            } catch (e) {
                console.error('æ›´æ–°ä¸‹è½½å†å²å¤±è´¥:', e);
            }
        }
        
        // æ˜¾ç¤ºä¸‹è½½å¸®åŠ©ä¿¡æ¯
        function showDownloadHelp(filename) {
            // åˆ›å»ºä¸‹è½½å¸®åŠ©å¯¹è¯æ¡†
            const helpDialog = document.createElement('div');
            helpDialog.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
            helpDialog.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-lg w-full">
                    <h3 class="text-xl font-bold mb-4">æ–‡ä»¶ä¸‹è½½ä¸­</h3>
                    <p class="mb-4">æ–‡ä»¶ <strong>${filename}</strong> æ­£åœ¨ä¸‹è½½ã€‚</p>
                    <p class="mb-4">ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæˆ‘ä»¬æ— æ³•æŒ‡å®šæ–‡ä»¶ä¸‹è½½ä½ç½®ã€‚è¯·æ£€æŸ¥æ‚¨çš„é»˜è®¤ä¸‹è½½æ–‡ä»¶å¤¹æˆ–æµè§ˆå™¨ä¸‹è½½æ ã€‚</p>
                    <p class="mb-6">æç¤ºï¼šæ‚¨å¯ä»¥åœ¨æµè§ˆå™¨è®¾ç½®ä¸­ä¿®æ”¹é»˜è®¤ä¸‹è½½ä½ç½®ã€‚</p>
                    <div class="flex justify-end">
                        <button id="close-help" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">æˆ‘çŸ¥é“äº†</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(helpDialog);
            
            document.getElementById('close-help').addEventListener('click', function() {
                document.body.removeChild(helpDialog);
            });
            
            // 5ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                if (document.body.contains(helpDialog)) {
                    document.body.removeChild(helpDialog);
                }
            }, 5000);
        }
    </script>

    <footer class="mt-6 text-center">
        <a id="beian-link" href="https://beian.miit.gov.cn/" target="_blank" class="text-blue-500 hover:underline"></a>
    </footer>

    <script>
        // Fetch the text for the link from the server
        fetch('/get_beian_text')
            .then(response => response.json())
            .then(data => {
                const beianLink = document.getElementById('beian-link');
                beianLink.textContent = data.text || 'å¤‡æ¡ˆä¿¡æ¯';
            })
            .catch(error => {
                console.error('Failed to fetch Beian text:', error);
            });

        // Fetch the website name and title from the server
        fetch('/get_website_config')
            .then(response => response.json())
            .then(data => {
                document.getElementById('website-title').textContent = data.title || 'Default Title';
                document.getElementById('website-name').textContent = data.name || 'Default Name';
            })
            .catch(error => {
                console.error('Failed to fetch website config:', error);
            });
    </script>
</body>
</html>